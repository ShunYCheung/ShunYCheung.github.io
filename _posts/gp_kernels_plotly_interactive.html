
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive GP Kernels — Plotly</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    p { margin: 0 0 16px; color: #4b5563; }
    .wrap { display: grid; grid-template-columns: 280px 1fr; gap: 16px; align-items: start; }
    .controls { background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; position: sticky; top: 12px; }
    .controls h2 { font-size: 14px; margin: 4px 0 8px; color: #374151; }
    .control { margin-bottom: 10px; }
    .control label { display: block; font-size: 12px; color: #374151; margin-bottom: 4px; }
    .row { display: flex; align-items: center; gap: 8px; }
    .value { min-width: 70px; text-align: right; font-variant-numeric: tabular-nums; color: #111827; }
    .note { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .plots { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .hidden { display: none; }
    select, input[type="range"], input[type="number"] { width: 100%; }
  </style>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
  <h1>Interactive Gaussian Process Kernels (Plotly)</h1>
  <p>Adjust hyperparameters to see the covariance matrix (left) and random GP draws (right). Everything runs client-side in the browser.</p>

  <div class="wrap">
    <div class="controls">
      <div class="control">
        <label for="kernel">Kernel</label>
        <select id="kernel">
          <option value="rbf">Squared Exponential (RBF)</option>
          <option value="periodic">Periodic (Exp-Sine-Squared)</option>
          <option value="rq">Rational Quadratic</option>
          <option value="matern32">Matérn 3/2</option>
          <option value="matern52">Matérn 5/2</option>
        </select>
        <div class="note" id="kdesc"></div>
      </div>

      <h2>Domain</h2>
      <div class="control">
        <label for="npoints"># time points</label>
        <div class="row">
          <input id="npoints" type="range" min="40" max="200" step="10" value="120" />
          <div class="value"><span id="npointsVal">120</span></div>
        </div>
        <div class="note">Larger = smoother but slower (Cholesky is O(N³)).</div>
      </div>
      <div class="control">
        <label>Time range</label>
        <div class="row">
          <input id="tmin" type="number" value="0" step="0.1" />
          <input id="tmax" type="number" value="10" step="0.1" />
        </div>
      </div>

      <h2>Hyperparameters</h2>
      <div class="control">
        <label for="var">Variance σ²</label>
        <div class="row">
          <input id="var" type="range" min="0.05" max="5" step="0.05" value="1" />
          <div class="value"><span id="varVal">1.00</span></div>
        </div>
      </div>
      <div class="control">
        <label for="ell">Length-scale ℓ</label>
        <div class="row">
          <input id="ell" type="range" min="0.1" max="5" step="0.05" value="1" />
          <div class="value"><span id="ellVal">1.00</span></div>
        </div>
      </div>
      <div class="control kern-periodic hidden">
        <label for="period">Period p (Periodic)</label>
        <div class="row">
          <input id="period" type="range" min="0.2" max="10" step="0.1" value="3" />
          <div class="value"><span id="periodVal">3.00</span></div>
        </div>
      </div>
      <div class="control kern-rq hidden">
        <label for="alpha">Shape α (Rational Quadratic)</label>
        <div class="row">
          <input id="alpha" type="range" min="0.1" max="5" step="0.05" value="1" />
          <div class="value"><span id="alphaVal">1.00</span></div>
        </div>
      </div>

      <h2>Sampling</h2>
      <div class="control">
        <label for="nsamples"># random draws</label>
        <div class="row">
          <input id="nsamples" type="range" min="1" max="8" step="1" value="4" />
          <div class="value"><span id="nsamplesVal">4</span></div>
        </div>
      </div>
      <div class="control">
        <label for="jitter">Numerical jitter (diagonal, 10^x)</label>
        <div class="row">
          <input id="jitter" type="range" min="-12" max="-6" step="0.5" value="-9" />
          <div class="value"><span id="jitterVal">1e-9</span></div>
        </div>
        <div class="note">Helps stabilise Cholesky for extreme params.</div>
      </div>
      <div class="control">
        <button id="resample">Resample draws (new noise)</button>
      </div>
    </div>

    <div class="plots">
      <div id="covPlot"></div>
      <div id="drawPlot"></div>
    </div>
  </div>

  <script>
    // --- Helpers ---
    const kernelSelect = document.getElementById('kernel');
    const npoints = document.getElementById('npoints');
    const tmin = document.getElementById('tmin');
    const tmax = document.getElementById('tmax');
    const varEl = document.getElementById('var');
    const ellEl = document.getElementById('ell');
    const periodEl = document.getElementById('period');
    const alphaEl = document.getElementById('alpha');
    const nsamples = document.getElementById('nsamples');
    const jitterEl = document.getElementById('jitter');
    const resampleBtn = document.getElementById('resample');

    const setText = (id, fmt=(x)=>x) => (v) => { document.getElementById(id).textContent = fmt(v); };
    const setNpointsVal = setText('npointsVal');
    const setVarVal     = setText('varVal',   v => Number(v).toFixed(2));
    const setEllVal     = setText('ellVal',   v => Number(v).toFixed(2));
    const setPeriodVal  = setText('periodVal',v => Number(v).toFixed(2));
    const setAlphaVal   = setText('alphaVal', v => Number(v).toFixed(2));
    const setNsamplesVal= setText('nsamplesVal');
    const setJitterVal  = setText('jitterVal',v => '1e' + String(v));

    function showClass(cls, show){
      document.querySelectorAll('.' + cls).forEach(el => {
        if (show) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
    }

    function updateKernelVisibility(){
      const k = kernelSelect.value;
      const desc = document.getElementById('kdesc');
      if (k === 'rbf')         desc.textContent = 'k(τ) = σ² exp(-τ² / (2ℓ²))';
      if (k === 'periodic')    desc.textContent = 'k(τ) = σ² exp( -2 sin²(πτ/p) / ℓ² )';
      if (k === 'rq')          desc.textContent = 'k(τ) = σ² (1 + τ² / (2 α ℓ²))^{-α}';
      if (k === 'matern32')    desc.textContent = 'k(τ) = σ² (1 + √3 τ/ℓ) exp(-√3 τ/ℓ)';
      if (k === 'matern52')    desc.textContent = 'k(τ) = σ² (1 + √5 τ/ℓ + 5τ²/(3ℓ²)) exp(-√5 τ/ℓ)';
      showClass('kern-periodic', k === 'periodic');
      showClass('kern-rq', k === 'rq');
    }

    function linspace(a,b,n){
      const step = (b-a)/(n-1), out = new Array(n);
      for (let i=0;i<n;i++) out[i] = a + i*step;
      return out;
    }

    function randn(){
      let u=0, v=0;
      while (u===0) u = Math.random();
      while (v===0) v = Math.random();
      return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
    }

    // Kernel matrix
    function kernelMatrix(T, ktype, sigma2, ell, period, alpha){
      const n = T.length;
      const K = new Array(n);
      const sqrt3 = Math.sqrt(3);
      const sqrt5 = Math.sqrt(5);
      for (let i=0;i<n;i++){
        const row = new Array(n);
        for (let j=0;j<n;j++){
          const tau = Math.abs(T[i]-T[j]);
          let val = 0;
          if (ktype === 'rbf'){
            val = sigma2 * Math.exp( - (tau*tau)/(2*ell*ell) );
          } else if (ktype === 'periodic'){
            const s = Math.sin(Math.PI * tau / period);
            val = sigma2 * Math.exp( -2 * (s*s) / (ell*ell) );
          } else if (ktype === 'rq'){
            const z = 1 + (tau*tau)/(2*alpha*ell*ell);
            val = sigma2 * Math.pow(z, -alpha);
          } else if (ktype === 'matern32'){
            const r = sqrt3 * tau / ell;
            val = sigma2 * (1 + r) * Math.exp(-r);
          } else if (ktype === 'matern52'){
            const r = sqrt5 * tau / ell;
            val = sigma2 * (1 + r + (r*r)/3) * Math.exp(-r);
          } else {
            val = (i===j) ? sigma2 : 0.0;
          }
          row[j] = val;
        }
        K[i] = row;
      }
      return K;
    }

    // Cholesky (lower-triangular)
    function cholesky(A){
      const n=A.length, L = new Array(n);
      for (let i=0;i<n;i++) L[i] = new Array(n).fill(0);
      for (let i=0;i<n;i++){
        for (let j=0;j<=i;j++){
          let s=0;
          for (let k=0;k<j;k++) s += L[i][k]*L[j][k];
          if (i===j){
            const d = A[i][i] - s;
            if (!(d>0) || !isFinite(d)) return null;
            L[i][j] = Math.sqrt(d);
          } else {
            L[i][j] = (A[i][j] - s) / L[j][j];
          }
        }
      }
      return L;
    }

    function addJitterInPlace(K, pow10){
      const j = Math.pow(10, pow10);
      for (let i=0;i<K.length;i++) K[i][i] += j;
    }

    function Lz(L){
      const n=L.length;
      const z = Array(n).fill(0).map(()=>randn());
      const y = new Array(n).fill(0);
      for (let i=0;i<n;i++){
        let s=0;
        for (let j=0;j<=i;j++) s += L[i][j] * z[j];
        y[i] = s;
      }
      return y;
    }

    // Initial plots
    Plotly.newPlot('covPlot', [{ z:[[0]], type:'heatmap', colorbar:{title:'k'} }], {
      title:'Covariance Matrix K',
      xaxis:{ title:'index' }, yaxis:{ title:'index', autorange:'reversed' },
      margin:{ t:40, r:10, b:45, l:55 }
    }, {responsive:true});

    Plotly.newPlot('drawPlot', [{ x:[0,1], y:[0,0], mode:'lines', name:'draw 1' }], {
      title:'Random Draws',
      xaxis:{ title:'t' }, yaxis:{ title:'f(t)' },
      margin:{ t:40, r:10, b:45, l:55 }, showlegend:true
    }, {responsive:true});

    function recompute(regenT=false){
      const N = parseInt(npoints.value, 10);
      const t0 = parseFloat(tmin.value);
      const t1 = parseFloat(tmax.value);
      const sigma2 = parseFloat(varEl.value);
      const ell = parseFloat(ellEl.value);
      const period = parseFloat(periodEl.value);
      const alpha = parseFloat(alphaEl.value);
      const jitterPow10 = parseFloat(jitterEl.value);
      const ktype = kernelSelect.value;

      setNpointsVal(N);
      setVarVal(sigma2);
      setEllVal(ell);
      setPeriodVal(period);
      setAlphaVal(alpha);
      setNsamplesVal(nsamples.value);
      setJitterVal(jitterEl.value);

      const T = linspace(t0, t1, N);
      const K = kernelMatrix(T, ktype, sigma2, ell, period, alpha);
      addJitterInPlace(K, jitterPow10);
      let L = cholesky(K);
      if (!L){
        // Increase jitter and retry once
        addJitterInPlace(K, -6);  // *another* 1e-6 on diag
        L = cholesky(K);
        if (!L){ alert('Matrix not SPD. Try more jitter or different params.'); return; }
      }

      // Update covariance heatmap via react
      Plotly.react('covPlot', [{ z: K, type:'heatmap', colorbar:{title:'k'} }], {
        title:'Covariance Matrix K',
        xaxis:{ title:'index' }, yaxis:{ title:'index', autorange:'reversed' },
        margin:{ t:40, r:10, b:45, l:55 }
      });

      // Build GP draws
      const m = parseInt(nsamples.value, 10);
      const traces = [];
      for (let i=0;i<m;i++){
        traces.push({ x: T, y: Lz(L), mode:'lines', name:'draw '+(i+1) });
      }
      Plotly.react('drawPlot', traces, {
        title:'Random Draws',
        xaxis:{ title:'t' }, yaxis:{ title:'f(t)' },
        margin:{ t:40, r:10, b:45, l:55 },
        showlegend:true
      });
    }

    // Wire up controls
    kernelSelect.onchange = () => { updateKernelVisibility(); recompute(true); };
    npoints.oninput = () => { recompute(true); };
    tmin.onchange = () => { recompute(true); };
    tmax.onchange = () => { recompute(true); };
    varEl.oninput = () => { recompute(); };
    ellEl.oninput = () => { recompute(); };
    periodEl.oninput = () => { recompute(); };
    alphaEl.oninput = () => { recompute(); };
    nsamples.oninput = () => { recompute(); };
    jitterEl.oninput = () => { recompute(); };
    resampleBtn.onclick = () => { recompute(); };

    updateKernelVisibility();
    recompute(true);
  </script>
</body>
</html>
